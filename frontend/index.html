<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalVox</title>
    <link rel="stylesheet" href="main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .output-box {
            margin-top: 0.5em;
            padding: 1em;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            background-color: #f9f9f9;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        } 
    </style>
</head>
<body class="bg-gray-50">

<div class="recorder-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="header-container text-center mb-8">
        <img src="vitalvoxlogo.png" alt="VitalVox" class="h-36 w-auto inline-block align-middle mr-4">
        <p class="text-md sm:text-lg text-black mt-2">AI-Powered Audio Transcription and Analysis for EMS</p>
    </div>

    <div class="w-full md:flex md:space-x-8">

        <div class="md:w-1/3 p-6 bg-white rounded-lg shadow-md">
            <div class="recorder-icon-box mx-auto w-fit">
                <img src="microphone.png" alt="Microphone Icon" class="w-16 h-16 text-gray-500">
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 text-center mt-4">Record Audio</h2>

            <div class="action-buttons mt-6">
                <button id="startButton" class="record-btn">Start</button>
                <button id="stopButton" class="record-btn" disabled>Stop</button>
            </div>

            <p id="status" class="status-message text-center">Ready</p>

            <div id="playback-section" class="hidden mt-4">
                <audio id="audioElement" controls class="w-full"></audio>
                <a id="downloadLink" href="#" download="my-recording.webm" class="mt-2 text-blue-600 hover:underline block text-center">
                    Download Recording
                </a>
                <button id="transcribeRecordingButton" class="w-full mt-2">Transcribe Recording</button>
            </div>
        </div>

        <div class="md:w-2/3 mt-8 md:mt-0 p-6 bg-white rounded-lg shadow-md">
            <div class="transcribe-section">
                <h2 class="text-2xl font-semibold text-gray-800">Transcribe & Summarize Audio</h2>
                <div class="upload-controls my-4 flex items-center justify-center gap-4">
                    <input type="file" id="audioFileInput" accept="audio/*" class="hidden">
                    <label for="audioFileInput" class="custom-file-upload">
                        Choose Audio File
                    </label>
                    <button id="transcribeButton">Transcribe Uploaded File</button>
                </div>
                <p id="transcriptionStatus" class="status-message text-center"></p>

                <h3 class="text-xl font-semibold text-gray-700 mt-4">Transcript</h3>
                <div id="transcriptOutput" class="output-box"></div>
                
                <div class="lg:flex lg:space-x-4">
                    <div class="w-full lg:w-1/2">
                        <h3 class="text-xl font-semibold text-gray-700 mt-4">Gemini Summary</h3>
                        <div id="geminiOutput" class="output-box"></div>
                    </div>
                    <div class="w-full lg:w-1/2 mt-4 lg:mt-0">
                         <h3 class="text-xl font-semibold text-gray-700 mt-4">Possible Suggestions for EMTs</h3>
                         <div id="adviceOutput" class="output-box"></div>
                    </div>
                </div>
            </div>
            <button id="exportButton" class="record-btn mt-6" style="background-color: #0077b6;">Export All</button>
        </div>
    </div>
</div>

<div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
        <p id="messageText" class="text-gray-800 mb-4"></p>
        <button id="closeMessage" class="bg-blue-500 text-white px-4 py-2 rounded-md">OK</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const audioElement = document.getElementById('audioElement');
        const status = document.getElementById('status');
        const downloadLink = document.getElementById('downloadLink');
        const playbackSection = document.getElementById('playback-section');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');
        const audioFileInput = document.getElementById('audioFileInput');
        const transcribeButton = document.getElementById('transcribeButton');
        const transcriptOutput = document.getElementById('transcriptOutput');
        const transcriptionStatus = document.getElementById('transcriptionStatus');
        const geminiOutput = document.getElementById('geminiOutput');
        const adviceOutput = document.getElementById('adviceOutput');
        const transcribeRecordingButton = document.getElementById('transcribeRecordingButton');
        
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob = null;

        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        closeMessage.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // --- Start Recording ---
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                playbackSection.classList.add('hidden');
                audioElement.src = '';

                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                // THIS IS THE ONLY 'stop' LISTENER. ALL LOGIC IS NOW HERE.
                mediaRecorder.addEventListener('stop', () => {
                    recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedAudioBlob);
                    
                    audioElement.src = audioUrl;
                    playbackSection.classList.remove('hidden');
                    downloadLink.href = audioUrl;
                    downloadLink.download = 'my-recording.webm';
                    
                    status.textContent = 'Recording stopped. Play, download, or transcribe below.';
                    startButton.disabled = false;
                    stopButton.disabled = true;

                    // This makes sure the browser releases the microphone
                    stream.getTracks().forEach(track => track.stop());
                });

                mediaRecorder.start();
                startButton.disabled = true;
                stopButton.disabled = false;
                status.textContent = 'Recording...';

            } catch (error) {
                console.error('Error accessing microphone:', error);
                showMessage('Error: Please allow microphone access to record audio.');
            }
        });

        // --- Stop Recording ---
        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        });

        // THE DUPLICATE 'stop' LISTENER THAT WAS HERE HAS BEEN REMOVED.
        // This allows the following code to run without crashing.

        // --- Transcribe Recorded Audio Button ---
        transcribeRecordingButton.addEventListener('click', () => {
            if (recordedAudioBlob) {
                transcribeAudio(recordedAudioBlob);
            } else {
                showMessage("No recorded audio available to transcribe.");
            }
        });
        
        // --- Transcribe Uploaded File Button ---
        transcribeButton.addEventListener('click', () => {
            const audioFile = audioFileInput.files[0];
            if (!audioFile) {
                showMessage('Please select an audio file to transcribe.');
                return;
            }
            transcribeAudio(audioFile);
        });

        // Inside the <script> tag in index.html, within the DOMContentLoaded listener

        const exportButton = document.getElementById('exportButton');

        exportButton.addEventListener('click', () => {
            // 1. Get the text from all three output boxes
            const transcriptText = document.getElementById('transcriptOutput').textContent;
            const summaryText = document.getElementById('geminiOutput').textContent;
            const adviceText = document.getElementById('adviceOutput').textContent;

            // Check if there's any text to export
            if (!transcriptText && !summaryText && !adviceText) {
                showMessage("There is no content to export yet.");
                return;
            }

            // 2. Combine the text into a single, formatted string
            const combinedText = `
        ========================
        VITALVOX TRANSCRIPT
        ========================

        ${transcriptText}

        ========================
        GEMINI SUMMARY
        ========================

        ${summaryText}

        ========================
        EMT ADVICE
        ========================

        ${adviceText}
        `;

            // 3. Create a blob and trigger a download
            const blob = new Blob([combinedText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary link element to trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = 'VitalVox-Analysis.txt'; // The name of the downloaded file
            document.body.appendChild(a);
            a.click();
            
            // Clean up by removing the link and revoking the URL
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });


        // --- Shared Transcription Function ---
        async function transcribeAudio(audioData) {
            transcriptionStatus.textContent = 'Processing... Please wait.';
            transcribeButton.disabled = true;
            transcribeRecordingButton.disabled = true;
            transcriptOutput.textContent = '';
            geminiOutput.textContent = '';
            adviceOutput.textContent = '';

            const formData = new FormData();
            formData.append('audioFile', audioData, 'recording.webm');

            try {
                const response = await fetch('https://vitalvox-backend.onrender.com/transcribe-and-summarize', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();
                if (data.success) {
                    transcriptionStatus.textContent = 'Complete!';
                    transcriptOutput.textContent = data.transcript;
                    geminiOutput.textContent = data.summary;
                    adviceOutput.textContent = data.advice;
                } else {
                    transcriptionStatus.textContent = 'Error';
                    showMessage(`Operation failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Error sending file to server:', error);
                transcriptionStatus.textContent = 'Error';
                showMessage('Failed to connect to the server. Is it running?');
            } finally {
                transcribeButton.disabled = false;
                transcribeRecordingButton.disabled = false;
            }
        }
    });
</script>

</body>
</html>