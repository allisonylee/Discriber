<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discriber</title>
    <link rel="stylesheet" href="main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

<div class="recorder-container">
    <div class="header-container">
        <h1 class="text-5xl font-extrabold text-gray-900">Discriber</h1>
    </div>
    <div class="recorder-icon-box">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-gray-500">
            <path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" />
            <path d="M15.75 17.25v2.25a.75.75 0 01-1.5 0v-2.25a3 3 0 00-3-3h-.75a3 3 0 00-3 3v2.25a.75.75 0 01-1.5 0v-2.25a4.5 4.5 0 019 0zm-1.5 6a.75.75 0 01-.75.75h-3a.75.75 0 01-.75-.75v-.75a.75.75 0 011.5 0v.64c.594-.28 1.134-.633 1.638-1.043a.75.75 0 01.996 1.129c-.771.681-1.637 1.258-2.605 1.703a.75.75 0 01-.58-.083.75.75 0 01-.482-.68v-.575a.75.75 0 011.5 0v.575a.75.75 0 01-.75.75H12a.75.75 0 01-.75-.75v-.75a.75.75 0 011.5 0v.64c.594-.28 1.134-.633 1.638-1.043a.75.75 0 01.996 1.129c-.771.681-1.637 1.258-2.605 1.703a.75.75 0 01-.58-.083.75.75 0 01-.482-.68v-.575a.75.75 0 011.5 0z" />
        </svg>
    </div>

    <h2 class="text-2xl font-semibold text-gray-800">Record Audio</h2>

    <div class="action-buttons">
        <button id="startButton" class="record-btn">
            Start
        </button>
        <button id="stopButton" class="record-btn" disabled>
            Stop
        </button>
    </div>

    <p id="status" class="status-message">Ready</p>

    <div id="playback-section" class="hidden">
        <audio id="audioElement" controls></audio>
        <a id="downloadLink" href="#" download="my-recording.webm" class="mt-4">
            Download Recording
        </a>
    </div>

    <div class="transcribe-section">
        <h2 class="text-2xl font-semibold text-gray-800">Transcribe Audio</h2>
        <div class="upload-controls">
            <input type="file" id="audioFileInput" accept="audio/*" class="w-full">
            <button id="transcribeButton">Transcribe</button>
        </div>
        <p id="transcriptionStatus" class="status-message text-center"></p>
        <div id="transcriptOutput" class="mt-4"></div>
    </div>

    <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-gray-800 mb-4"></p>
            <button id="closeMessage" class="bg-blue-500 text-white px-4 py-2 rounded-md">OK</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const audioElement = document.getElementById('audioElement');
        const status = document.getElementById('status');
        const downloadLink = document.getElementById('downloadLink');
        const playbackSection = document.getElementById('playback-section');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');

        const audioFileInput = document.getElementById('audioFileInput');
        const transcribeButton = document.getElementById('transcribeButton');
        const transcriptOutput = document.getElementById('transcriptOutput');
        const transcriptionStatus = document.getElementById('transcriptionStatus');

        let mediaRecorder;
        let audioChunks = [];

        // --- Helper function for displaying messages ---
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        closeMessage.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // --- Start Recording ---
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                playbackSection.classList.add('hidden');
                audioElement.src = '';
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioElement.src = audioUrl;
                    playbackSection.classList.remove('hidden');
                    downloadLink.href = audioUrl;
                    downloadLink.download = 'my-recording.webm';
                    downloadLink.click();
                    stream.getTracks().forEach(track => track.stop());
                });

                mediaRecorder.start();
                startButton.disabled = true;
                stopButton.disabled = false;
                status.textContent = 'Recording...';

            } catch (error) {
                console.error('Error accessing microphone:', error);
                showMessage('Error: Please allow microphone access to record audio.');
            }
        });

        // --- Stop Recording ---
        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                status.textContent = 'Recording stopped. Play or download below.';
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        });

        // --- Transcribe Audio Functionality ---
        // This is the updated section that connects to your server
        transcribeButton.addEventListener('click', async () => {
            const audioFile = audioFileInput.files[0];
            if (!audioFile) {
                showMessage('Please select an audio file to transcribe.');
                return;
            }

            transcriptionStatus.textContent = 'Uploading and transcribing... Please wait.';
            transcribeButton.disabled = true;
            transcriptOutput.textContent = '';

            // Create a FormData object to send the file
            const formData = new FormData();
            formData.append('audioFile', audioFile); // 'audioFile' must match the name in server.js

            try {
                // Send the file to your backend server's '/transcribe' endpoint
                const response = await fetch('http://localhost:3000/transcribe', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (data.success) {
                    // Display the transcript returned from the server
                    transcriptionStatus.textContent = 'Transcription complete!';
                    transcriptOutput.textContent = data.transcript;
                } else {
                    transcriptionStatus.textContent = 'Error';
                    showMessage(`Transcription failed: ${data.message}`);
                }

            } catch (error) {
                console.error('Error sending file to server:', error);
                transcriptionStatus.textContent = 'Error';
                showMessage('Failed to connect to the server. Is it running?');
            } finally {
                transcribeButton.disabled = false;
            }
        });
    }); 
</script>

</body>
</html>